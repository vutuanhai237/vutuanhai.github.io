---
layout: post
title: "QML #2: Gradient lượng tử"
categories: quantum-computing
link: https://vutuanhai237.github.io/haskell/2021/06/6/qc-2.html
---

### **2.0. Gradient Descent**

Trong Machine Learning nói riêng và Toán Tối Ưu nói chung, chúng ta thường xuyên phải tìm giá trị nhỏ nhất (hoặc đôi khi là lớn nhất) của một hàm số nào đó. Ví dụ như các hàm mất mát trong hai bài Linear Regression và K-means Clustering. Nhìn chung, việc tìm global minimum của các hàm mất mát trong Machine Learning là rất phức tạp, thậm chí là bất khả thi. Thay vào đó, người ta thường cố gắng tìm các điểm local minimum, và ở một mức độ nào đó, coi đó là nghiệm cần tìm của bài toán.

### **2.0. Numerial Gradient**

Giả sử $f$ là black box, tức là ta không biết chi tiết $f$ chứa những gì mà chỉ biết đầu ra, đầu vào tương ứng. Ví dụ: ta có hàm $f(x)=x+1$ nhưng phần $x+1$ bị dấu đi hoặc không tiện để xét đến, ta biết được thông tin $f(1)=2, f(2)=3, ...$ chẳng hạn.

Do đó, khi tính giá trị đạo hàm tại một điểm nào đó như $f'(x)$ thì phải tính gián tiếp thông qua phương pháp số. phương pháp này sinh ra từ định nghĩa ban đầu của đạo hàm:
$
f'(x)=\lim_{\epsilon\to0} \frac{f(x+\epsilon)-f(x)}{\epsilon}
$

Dùng khai triển Taylor với $f(x+\epsilon)$ và $f(x-\epsilon)$:

$f(x+\epsilon)\approx f(x)+\frac{f'(x)(x+\epsilon-x)}{1!}+...=f(x)+f'(x)\epsilon+... (1)$ 
$f(x-\epsilon)\approx f(x)+\frac{f'(x)(x-\epsilon-x)}{1!}+...=f(x)-f'(x)\epsilon+... (2)$ 

Lấy $\frac{(1)-(2)}{2\epsilon}:$

$\frac{f(x+\epsilon)-f(x-\epsilon)}{2\epsilon}\approx f'(x)+\frac{f^{(3)}(x)}{6}\epsilon^2+...=f'(x)+O(\epsilon^2) (3)$

Như vậy nếu $\epsilon$ xấp xỉ $0$, ta sẽ lấy được đạo hàm của $f$ tại điểm $x$ thông qua hai lần gọi hàm. Đây được gọi là phương pháp bậc 0.

Tổng quát hóa và bỏ qua độ lỗi, ta có thể viết lại công thức $(3)$ như sau:

$f'(x)= r(f(x+\epsilon)-f(x-\epsilon))$

Ví dụ:

$f(x)=\sin(x)$, với $r=\frac{1}{2}$ và $\epsilon=\frac{\pi}{2}$, ta có:

$f'(x)=\frac{1}{2}(f(x+\frac{\pi}{2})-f(x-\frac{\pi}{2}))$

$=\frac{1}{2}(\sin(x+\frac{\pi}{2})-\sin(x-\frac{\pi}{2}))$

$=\frac{1}{2}(\cos(x)+\cos(x))=\cos(x)$

Phương pháp này được gọi là **parameter-shift**, dịch thô là **dời tham số**.



Trong mạng QNN, tính đạo hàm là một phần tất yếu, ta có đạo hàm 
Giả sử ta có chuỗi các cổng $U(\theta)$ phụ thuộc vào tập tham số $\theta$ phụ thuộc vào quan sát $\hat{B}$, phụ thuộc vào quan sát có nghĩa là, chẳng hạn, nếu $\hat{B}$ là ma trận Pauli $Z=
\begin{bmatrix}
1 & 0\\
0 & -1
\end{bmatrix}$, khi đo qubit trong trạng thái $\mid 0\rangle$ hoặc $\mid 1\rangle$ thì có thể ngầm hiểu là kết quả là trị riêng của pauli $Z$ $\pm1$ tương ứng.

Hàm loss có dạng:

$f(\theta):R^m \rightarrow R^n:=\langle 0 \mid U^\dagger(\theta)\hat{B}U(\theta)\mid 0\rangle$

Về mặt vật lý, chúng ta phải chạy mạch này nhiều lần để lấy trung bình k lần đo là xấp xỉ của f(0). Tuy nhiên, nếu là giả lập thì không cần phải làm như vậy.
Giả sử cả mạch chỉ bao gồm của G HOA (Muy)
Chúng ta tính đạo hàm của mạch là \partial f(theta) với muy thuộc theta
Có một số phương pháp như sai phân hữu hạn: 
Đ…..
Tuy nhiên phương pháp này đạt độ chính xác không cao.



### **2.3. Tiền chứng minh**

**Chứng minh (1)**: Với $B,C$ là hai toán tử bất kỳ, ta xét hệ:

$\langle\psi\mid B^\dagger\hat{Q}C \mid\psi\rangle+h.c$

$=\langle\psi \mid B^\dagger\hat{Q}C\mid\psi\rangle+\langle\psi\mid C^\dagger\hat{Q}B\mid\psi\rangle$

$=\frac{1}{2}\langle\psi\mid(2B^\dagger C+2C^\dagger B)\hat{Q}\mid\psi\rangle$

$=\frac{1}{2}\langle\psi\mid(B^\dagger B+B^\dagger C+C^\dagger B+C^\dagger C)\hat{Q}\mid\psi\rangle - \frac{1}{2}\langle\psi\mid(B^\dagger B-B^\dagger C-C^\dagger B+C^\dagger C)\hat{Q}\mid\psi\rangle$

$=\frac{1}{2}\langle\psi\mid(B^\dagger + C^\dagger)(B+C)\hat{Q}\mid\psi\rangle - \frac{1}{2}\langle\psi\mid(B^\dagger - C^\dagger)(B-C)\hat{Q}\mid\psi\rangle$

**Chứng minh (2)**: Xét ma trận Hermit $G$ có hai trị riêng đối xứng $\pm r$ trong bộ cổng $\mathcal{G}(\mu)=e^{-i\mu G}$, $G=r^2\mathbb{I}$ với $\mathbb{I}$ là ma trận đơn vị có kích thước tương ứng.

Ví dụ:

Xét ma trận Pauli $X = 
\begin{bmatrix}
0 & 1\\
1 & 0
\end{bmatrix}$ có hai trị riêng $\pm 1$, $X^2=
\begin{bmatrix}
0 & 1\\
1 & 0
\end{bmatrix}\begin{bmatrix}
0 & 1\\
1 & 0
\end{bmatrix}=\begin{bmatrix}
1 & 0\\
0 & 1
\end{bmatrix}$

Xét ma trận Hermit 

$$
M = 
\begin{bmatrix}
0 & (1+i) \\
(1-i) & 0
\end{bmatrix}
$$ 

có hai trị riêng $\pm \sqrt{2}$ và 

$$M^2=
\begin{bmatrix}
0 & (1+i)\\
(1-i) & 0
\end{bmatrix}\begin{bmatrix}
0 & (1+i)\\
(1-i) & 0
\end{bmatrix}=\begin{bmatrix}
2 & 0\\
0 & 2
\end{bmatrix}
$$

**Chứng minh (3)**: Sử dụng khai triển Taylor trên cổng $\mathcal{G}(\mu)=e^{-i\mu G}$:

$
e^{-i\mu G}=\sum_{k=0}^{\infty}\frac{(-i\mu)^k G^k}{k!}
$

Với $G=r^2\mathbb{I}$ từ chứng minh (2):

$
e^{-i\mu G}=\sum_{k=0}^{\infty}\frac{(-i\mu)^{2k} (r^2\mathbb{I})^{2k}}{2k!}+\sum_{k=0}^{\infty}\frac{(-i\mu)^{(2k+1)} (r^2\mathbb{I})^{(2k+1)}}{(2k+1)!}
$

$
=\mathbb{I}\sum_{k=0}^{\infty}\frac{(-1)^{k} (r\mu)^{2k}}{2k!}-\frac{i}{r}G\sum_{k=0}^{\infty}\frac{(-1)^{k} (r\mu)^{(2k)}}{(2k+1)!}
$

$
=\mathbb{I}\cos(r\mu)-\frac{i}{r}G\sin(r\mu)
$

$
\rightarrow \mathcal{G}(\frac{\pi}{4r})=\frac{1}{\sqrt{2}}(\mathbb{I}-\frac{i}{r}G), \mathcal{G}(-\frac{\pi}{4r})=\frac{1}{\sqrt{2}}(\mathbb{I}+\frac{i}{r}G)
$

#### **3. Tóm tắt**

Để đơn giản hóa, chúng ta lấy tập tham số con $\mu\in\theta$ thuộc cổng $\mathcal{G}(\mu)$, $U(\theta)$ được đơn giản hóa là $U(\theta)=V\mathcal{G}(\mu)W$. Ở đây mình dùng $f$ thay cho $f(\mu)$ và $\mathcal{G}$ thay cho $\mathcal{G}(\mu)$ vì cả hai đại lượng đều phụ thuộc vào $\mu$. Khi tính gradient trên $f$:

$\partial_{\mu}f=\partial_{\mu}\langle\psi\mid\mathcal{G}^{\dagger}\hat{Q}\mathcal{G}\mid\psi\rangle$

$
=\langle\psi\mid\mathcal{G}^{\dagger}\hat{Q}(\partial_{\mu}\mathcal{G})\mid\psi\rangle+\langle\psi\mid(\partial_{\mu}\mathcal{G})^{\dagger}\hat{Q}\mathcal{G}\mid\psi\rangle (4)
$

với $\hat{Q}=V^\dagger\hat{B}V$ và $\mid\psi\rangle=W\mid 0\rangle$

Với $\mathcal{G}(\mu)=e^{-i\mu G}$, suy ra $\partial_{\mu}\mathcal{G}(\mu)=-iGe^{-i\mu G}=-iG\mathcal{G}(\mu)\; (5)$

Thế $(5)$ vào $(4)$, ta được:

$
\partial_{\mu}f=\langle\psi\mid\mathcal{G}^{\dagger}\hat{Q}(-iG\mathcal{G})\mid\psi\rangle+\langle\psi\mid(-iG\mathcal{G})^{\dagger}\hat{Q}\mathcal{G}\mid\psi\rangle
$

với $\langle\psi\mid\mathcal{G}^\dagger=\langle\psi^{'}\mid$ và $\mathcal{G}\mid\psi\rangle=\;\mid\psi^{'}\rangle$:

$
\partial_{\mu}f=\langle\psi^{'}\mid\hat{Q}(-iG)\mid\psi^{'}\rangle+\langle\psi^{'}\mid\hat{Q}(-iG)^{\dagger}\mid\psi^{'}\rangle \;
$

$
=r(\langle\psi^{'}\mid\mathbb{I}\hat{Q}(-\frac{i}{r}G)\mid\psi^{'}\rangle+\langle\psi^{'}\mid\mathbb{I}\hat{Q}(-\frac{i}{r}G)^{\dagger}\mid\psi^{'}\rangle) \;(6)
$

Nếu $n$ trị riêng của $G$ chỉ có hai giá trị $a$ và $b$ với $a\neq b$, chúng ta có thể chuyển các trị riêng thành $\pm r$, vì pha toàn cục (global phase) không quan sát được.

Sử dụng chứng minh (1) với phương trình (6) trong trường hợp $B=\mathbb{I}$ và $C=-\frac{i}{r}G$. (Lưu ý rằng $G$ là ma trận Hermit ($G^{\dagger}=G$) nên $(-\frac{i}{r}G)^{\dagger}=\frac{i}{r}G$, ngoài ra thì $\mathbb{I}^\dagger=\mathbb{I}$). 

$
\partial_{\mu}f=\frac{r}{2}(\langle\psi^{'}\mid(\mathbb{I}-\frac{i}{r}G)^\dagger\hat{Q}(\mathbb{I}-\frac{i}{r}G)\mid\psi^{'}\rangle+\langle\psi^{'}\mid(\mathbb{I}+\frac{i}{r}G)^\dagger\hat{Q}(\mathbb{I}+\frac{i}{r}G)\mid\psi^{'}\rangle \;(7)
$

Sử dụng kết quả từ chứng minh (3) với $ \mathcal{G}(\frac{\pi}{4r})=\frac{1}{\sqrt{2}}(\mathbb{I}-\frac{i}{r}G)$ và $ \mathcal{G}(-\frac{\pi}{4r})=\frac{1}{\sqrt{2}}(\mathbb{I}+\frac{i}{r}G)$.

$
\partial_{\mu}f=\frac{r}{2}(\langle\psi^{'}\mid\sqrt{2}(\mathcal{G}(\frac{\pi}{4r})^\dagger)\hat{Q}\sqrt{2}\mathcal{G}(\frac{\pi}{4r})\mid\psi^{'}\rangle+\langle\psi^{'}\mid\sqrt{2}(\mathcal{G}(-\frac{\pi}{4r})^\dagger)\hat{Q}\sqrt{2}\mathcal{G}(-\frac{\pi}{4r})\mid\psi^{'}\rangle)
$

với $\langle\psi\mid\mathcal{G}^\dagger=\langle\psi^{'}\mid$ và $\mathcal{G}\mid\psi\rangle=\;\mid\psi^{'}\rangle$:

$
\partial_{\mu}f=r(\langle\psi\mid\mathcal{G}^\dagger(\mathcal{G}(\frac{\pi}{4r})^\dagger)\hat{Q}\mathcal{G}(\frac{\pi}{4r})\mathcal{G}\mid\psi\rangle+\langle\psi\mid\mathcal{G}^\dagger(\mathcal{G}(-\frac{\pi}{4r})^\dagger)\hat{Q}\mathcal{G}(-\frac{\pi}{4r})\mathcal{G}\mid\psi\rangle)
$

với $\mathcal{G}(\mu+s)=e^{-i(\mu+s)G}=e^{-i\mu G}e^{-isG}=\mathcal{G}(\mu)\mathcal{G}(s)$:

$
\partial_{\mu}f=r(\langle\psi\mid\mathcal{G}(\mu+\frac{\pi}{4r})^\dagger\hat{Q}\mathcal{G}(\mu+\frac{\pi}{4r})\mid\psi\rangle+\langle\psi\mid(\mathcal{G}(\mu-\frac{\pi}{4r})^\dagger)\hat{Q}\mathcal{G}(\mu-\frac{\pi}{4r})\mid\psi\rangle)
$

$
= r(f(\mu+\frac{\pi}{4r})-f(\mu-\frac{\pi}{4r}))
$


*Kết thúc bài 1*



<p style="text-align: right">Tác giả</p>

<p style="text-align: right;">
Vũ Tuấn Hải - Monadotory
</p>
