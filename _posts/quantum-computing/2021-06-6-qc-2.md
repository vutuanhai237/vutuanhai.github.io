---
layout: post
title: "QML #2: Gradient lượng tử"
categories: quantum-computing
link: https://vutuanhai237.github.io/haskell/2021/06/6/qc-2.html
---

#### **1.Giới thiệu**

Trong trường hợp các bài toán Machine Learning cổ điển, chúng ta phải tìm giá trị nhỏ nhất của hàm số $f$ (cost / loss function) nào đó. Chiến lược chung là tìm các điểm cực tiểu toàn cục, hoặc trong một số bài toán khó cũng có thể chấp nhận nghiệm là cực tiểu địa phương thông qua đạo hàm. Đối với lớp các bài toán Quantum Machine Learning, ý tưởng chủ đạo vẫn được giữ nguyên.

Chiến thuật tìm các điểm cực tiểu được mô tả sau. Chúng ta có hàm $f$ phụ thuộc biến  với $x^{*}$ là cực tiểu toàn cục và $X=\{x^{(0)},x^{(1)},...,x^{(n)}\}$ là tập các thử nghiệm (ansatz) trong $n$ vòng lặp, $x^{(0)}$ là giá trị khởi tạo, $x$ không chỉ là giá trị vô hướng mà có thể là vector, ma trận hoặc đại lượng nhiều chiều hơn. Ở đây ta cần đưa $x\approx\;x^{*}$ càng tốt và $x=x^{*}$ là tốt nhất.

Nhờ tính chất ngược hướng của đạo hàm (luôn hướng từ thấp lên cao, trong khi chúng ta đang cần $x$ di chuyển từ cao xuống thấp), giá trị mới của $x$ được cập nhật theo quy tắc sau:

$
x^{(t+1)}=x^{(t)}-\alpha\nabla f(x^{(t)})
$

với $\alpha\in\mathbb{R}$ là hệ số dùng để điều chỉnh tốc độ cập nhật (learning rate) và $\nabla f(x^{(t)})=[\frac{\partial f(x^{(t)})}{x_1} \;\frac{\partial f(x^{(t)})}{x_2} \;...]$ là gradient của $f$ tại $x^{(t)}$.

Tuy rõ ràng và dễ hiểu như vậy nhưng trong nhiều trường hợp thực tế $f$ lại là hàm ẩn (black box) do không có thông tin chi tiết về $f$ hoặc $f$ quá phức tạp để xét đến. 

### **1. Numerial Gradient**

Để khắc phục nhược điểm này, chúng ta có một số phương pháp tính gián tiếp giá trị đạo hàm tại một điểm nào đó như $f'(x)$ như sai phân hữu hạn, phương pháp này được chứng minh như sau:

Dùng khai triển Taylor với $f(x+\epsilon)$ và $f(x-\epsilon)$:

$f(x+\epsilon)\approx f(x)+\frac{f'(x)(x+\epsilon-x)}{1!}+...=f(x)+f'(x)\epsilon+...\;(1.1)$ 

$f(x-\epsilon)\approx f(x)+\frac{f'(x)(x-\epsilon-x)}{1!}+...=f(x)-f'(x)\epsilon+...\;(1.2)$ 

Lấy $\frac{(1.1)-(1.2)}{2\epsilon}:$

$\frac{f(x+\epsilon)-f(x-\epsilon)}{2\epsilon}\approx f'(x)+\frac{f^{(3)}(x)}{6}\epsilon^2+...=f'(x)+O(\epsilon^2)\;(1.3)$

Nếu $\epsilon\approx 0$, ta sẽ tính được gần đúng giá trị $f'(x)$ thông qua hai lần gọi hàm với độ lỗi $O(\epsilon^2)$. Đây còn có thể gọi là phương pháp bậc 0 vì không thông qua đạo hàm bậc cao hơn. Đối với tính toán lượng tử $O(\epsilon^2)$ vẫn quá lớn để chấp nhận, ngoài ra định nghĩa đưa ra chỉ tính được xấp xỉ, có thể tốn rất nhiều thời gian trong trường hợp hàm xấu.

Tổng quát hóa và bỏ qua độ lỗi, ta có thể viết lại công thức $(1.3)$ như sau:

$f'(x)= r(f(x+\epsilon)-f(x-\epsilon))\;(1.4)$

Ví dụ khi áp dụng sai phân hữu hạn trên $f(x)=\sin(x)$, giả sử $f(x)$ là hàm ẩn, với $r=\frac{1}{2}$ và $\epsilon=\frac{\pi}{2}$, ta có:

$f'(x)=\frac{1}{2}(f(x+\frac{\pi}{2})-f(x-\frac{\pi}{2}))$

$=\frac{1}{2}(\sin(x+\frac{\pi}{2})-\sin(x-\frac{\pi}{2}))$

$=\frac{1}{2}(\cos(x)+\cos(x))=\cos(x)$

Phương pháp mới này được gọi là **parameter-shift**, tức là chỉ thông qua việc dời tham số, ta lấy được giá trị đạo hàm của hàm số.

#### **2. Parameter shift**
Giả sử ta có chuỗi các cổng chứa tham số $U(\theta)$ phụ thuộc vào $\theta$ và quan sát $\hat{B}$, phụ thuộc vào quan sát có nghĩa là, chẳng hạn, nếu $\hat{B}$ là ma trận Pauli $$Z=\begin{bmatrix}1 & 0\\0 & -1\end{bmatrix}.$$Khi đo được qubit trong trạng thái $\mid 0\rangle$ hoặc $\mid 1\rangle$ thì ta có thể suy ra giá trị cần tìm là $1$ hoặc -$1$ tương ứng là trị riêng của pauli $Z$.

Hàm cần cực tiểu hóa $f$ có dạng:

$f(\theta):R^m \rightarrow R^n:=\langle 0 \mid U^\dagger(\theta)\hat{B}U(\theta)\mid 0\rangle\;(2.1)$

Về mặt vật lý, chúng ta phải chạy mạch này nhiều lần để lấy trung bình $k$ lần đo là xấp xỉ $f(0)$ với $k$ là hyperparameter.

Để tiện cho việc đọc hiểu, chúng ta cần biết trước về một số chứng minh.

**Chứng minh (2.1)**: Với $B,C$ là hai toán tử bất kỳ, ta xét đại lượng $\langle\psi\mid B^\dagger\hat{Q}C \mid\psi\rangle+h.c$

$=\langle\psi \mid B^\dagger\hat{Q}C\mid\psi\rangle+\langle\psi\mid C^\dagger\hat{Q}B\mid\psi\rangle$

$=\frac{1}{2}\langle\psi\mid(2B^\dagger C+2C^\dagger B)\hat{Q}\mid\psi\rangle$

$=\frac{1}{2}\langle\psi\mid(B^\dagger B+B^\dagger C+C^\dagger B+C^\dagger C)\hat{Q}\mid\psi\rangle - \frac{1}{2}\langle\psi\mid(B^\dagger B-B^\dagger C-C^\dagger B+C^\dagger C)\hat{Q}\mid\psi\rangle$

$=\frac{1}{2}\langle\psi\mid(B^\dagger + C^\dagger)(B+C)\hat{Q}\mid\psi\rangle - \frac{1}{2}\langle\psi\mid(B^\dagger - C^\dagger)(B-C)\hat{Q}\mid\psi\rangle$

**Chứng minh (2.2)**: Xét $G$ có hai trị riêng đối xứng $\pm r$ là ma trận Hermit cổng $\mathcal{G}(\mu)=e^{-i\mu G}$, $G=r^2\mathbb{I}$ với $\mathbb{I}$ là ma trận đơn vị có kích thước tương ứng.

Ví dụ:

Xét ma trận Pauli 
$$
X = 
\begin{bmatrix}
0 & 1\\
1 & 0
\end{bmatrix}$$ có hai trị riêng $\pm 1$, 
$$
X^2=
\begin{bmatrix}
0 & 1\\
1 & 0
\end{bmatrix}
=\mathbb{I}$$

Xét ma trận Hermit 

$$
M = 
\begin{bmatrix}
0 & (1+i) \\
(1-i) & 0
\end{bmatrix}
$$ 

có hai trị riêng $\pm \sqrt{2}$,

$$
M^2=
\begin{bmatrix}
2 & 0\\
0 & 2
\end{bmatrix}
=2\mathbb{I}$$

**Chứng minh (2.3)**: Sử dụng khai triển Taylor trên cổng $\mathcal{G}(\mu)=e^{-i\mu G}$:

$
e^{-i\mu G}=\sum_{k=0}^{\infty}\frac{(-i\mu)^k G^k}{k!}
$

Với $G=r^2\mathbb{I}$ từ chứng minh (2.2):

$
e^{-i\mu G}=\sum_{k=0}^{\infty}\frac{(-i\mu)^{2k} (r^2\mathbb{I})^{2k}}{2k!}+\sum_{k=0}^{\infty}\frac{(-i\mu)^{(2k+1)} (r^2\mathbb{I})^{(2k+1)}}{(2k+1)!}
$

$
=\mathbb{I}\sum_{k=0}^{\infty}\frac{(-1)^{k} (r\mu)^{2k}}{2k!}-\frac{i}{r}G\sum_{k=0}^{\infty}\frac{(-1)^{k} (r\mu)^{(2k)}}{(2k+1)!}
$

$
=\mathbb{I}\cos(r\mu)-\frac{i}{r}G\sin(r\mu)
$

$
\rightarrow \mathcal{G}(\frac{\pi}{4r})=\frac{1}{\sqrt{2}}(\mathbb{I}-\frac{i}{r}G), \mathcal{G}(-\frac{\pi}{4r})=\frac{1}{\sqrt{2}}(\mathbb{I}+\frac{i}{r}G)
$

#### **3. Parameter shift trong trường hợp $G$ có hai trị riêng phân biệt**

Để đơn giản hóa, giả sử mạch đơn giản gồm tập con tham số $\mu\in\theta$ và duy nhất cổng $\mathcal{G}$ phụ thuộc $\mu$, đạo hàm trên toàn mạch là đạo hàm riêng của $\mu$ được ký hiệu là $\partial_{\mu}f(\mu)$. Ở đây mình dùng $f$ thay cho $f(\mu)$ và $\mathcal{G}$ thay cho $\mathcal{G}(\mu)$ vì cả hai đại lượng đều phụ thuộc vào $\mu$. Lưu ý rằng tập các đạo hàm riêng sẽ chính là $\nabla f$ nên đối với trường hợp tổng quát sẽ không quá phức tạp.

Như vậy, ta có thể viết lại toàn bộ mạch dưới dạng $U(\theta)=V\mathcal{G}(\mu)W$, $\mathcal{G}(\mu)$ là cổng có tham số duy nhất, $V, W$ là các bộ cổng phi tham số còn lại.

$f(\mu)=\langle 0 \mid U^\dagger\hat{B}U\mid 0\rangle$

$
=\langle 0 \mid (V\mathcal{G}(\mu)W)^\dagger\hat{B}(V\mathcal{G}(\mu)W)\mid 0\rangle
$

$
=\langle 0 \mid W^\dagger\mathcal{G}^\dagger(\mu)(V^\dagger\hat{B}V)\mathcal{G}(\mu)W\mid 0\rangle\;(3.1)
$

Hấp thụ $V$ vào đại lượng quan sát $\hat{B}$ và $W$ vào trạng thái $|0\rangle$, ta thể $V^\dagger\hat{B}V=\hat{Q}$, $W\mid\;0\rangle=\mid\psi\rangle$ và $\langle 0 \mid W=\langle\psi\mid$ vào phương trình (3.1):

$f=\langle\psi\mid\mathcal{G}^{\dagger}\hat{Q}\mathcal{G}\mid\psi\rangle$

Khi lấy đạo hàm riêng của $f$ đối với $\mu$:

$\partial_{\mu}f=\partial_{\mu}\langle\psi\mid\mathcal{G}^{\dagger}\hat{Q}\mathcal{G}\mid\psi\rangle$

$
=\langle\psi\mid\mathcal{G}^{\dagger}\hat{Q}(\partial_{\mu}\mathcal{G})\mid\psi\rangle+\langle\psi\mid(\partial_{\mu}\mathcal{G})^{\dagger}\hat{Q}\mathcal{G}\mid\psi\rangle\;(3.2)
$

Với $\mathcal{G}(\mu)=e^{-i\mu G}$, suy ra $\partial_{\mu}\mathcal{G}(\mu)=-iGe^{-i\mu G}=-iG\mathcal{G}(\mu)\; (3.3)$

Thế $(3.3)$ vào phương trình $(3.2)$, ta được:

$
\partial_{\mu}f=\langle\psi\mid\mathcal{G}^{\dagger}\hat{Q}(-iG\mathcal{G})\mid\psi\rangle+\langle\psi\mid(-iG\mathcal{G})^{\dagger}\hat{Q}\mathcal{G}\mid\psi\rangle
$

với $\langle\psi\mid\mathcal{G}^\dagger=\langle\psi^{'}\mid$ và $\mathcal{G}\mid\psi\rangle=\;\mid\psi^{'}\rangle$:

$
\partial_{\mu}f=\langle\psi^{'}\mid\hat{Q}(-iG)\mid\psi^{'}\rangle+\langle\psi^{'}\mid(-iG)^{\dagger}\hat{Q}\mid\psi^{'}\rangle \;
$

$
=r(\langle\psi^{'}\mid\mathbb{I}^\dagger\hat{Q}(-\frac{i}{r}G)\mid\psi^{'}\rangle+\langle\psi^{'}\mid(-\frac{i}{r}G)^{\dagger}\hat{Q}\mathbb{I}\mid\psi^{'}\rangle) \;(3.4)
$

Nếu $n$ trị riêng của $G$ chỉ có hai giá trị $a$ và $b$ với $a\neq b$, chúng ta có thể chuyển các trị riêng thành $\pm r$, vì pha toàn cục (global phase) không quan sát được.

Sử dụng chứng minh (2.1) trong phương trình (3.4) trong trường hợp $B=\mathbb{I}$ và $C=-\frac{i}{r}G$.

*Lưu ý rằng $G$ là ma trận Hermit ($G^{\dagger}=G$) nên $(-\frac{i}{r}G)^{\dagger}=\frac{i}{r}G$, ngoài ra thì $\mathbb{I}^\dagger=\mathbb{I}$.* 

$
\partial_{\mu}f=\frac{r}{2}(\langle\psi^{'}\mid(\mathbb{I}-\frac{i}{r}G)^\dagger\hat{Q}(\mathbb{I}-\frac{i}{r}G)\mid\psi^{'}\rangle+\langle\psi^{'}\mid(\mathbb{I}+\frac{i}{r}G)^\dagger\hat{Q}(\mathbb{I}+\frac{i}{r}G)\mid\psi^{'}\rangle \;(3.5)
$

Sử dụng kết quả từ chứng minh (2.3) với $ \mathcal{G}(\frac{\pi}{4r})=\frac{1}{\sqrt{2}}(\mathbb{I}-\frac{i}{r}G)$ và $ \mathcal{G}(-\frac{\pi}{4r})=\frac{1}{\sqrt{2}}(\mathbb{I}+\frac{i}{r}G)$.

$
\partial_{\mu}f=\frac{r}{2}(\langle\psi^{'}\mid\sqrt{2}\mathcal{G}^\dagger(\frac{\pi}{4r})\hat{Q}\sqrt{2}\mathcal{G}(\frac{\pi}{4r})\mid\psi^{'}\rangle+\langle\psi^{'}\mid\sqrt{2}\mathcal{G}^\dagger(-\frac{\pi}{4r})\hat{Q}\sqrt{2}\mathcal{G}(-\frac{\pi}{4r})\mid\psi^{'}\rangle)
$

với $\langle\psi^{'}\mid=\langle\psi\mid\mathcal{G}^\dagger$ và $\;\mid\psi^{'}\rangle=\mathcal{G}\mid\psi\rangle$:

$
\partial_{\mu}f=r(\langle\psi\mid\mathcal{G}^\dagger\mathcal{G}^\dagger(\frac{\pi}{4r})\hat{Q}\mathcal{G}(\frac{\pi}{4r})\mathcal{G}\mid\psi\rangle+\langle\psi\mid\mathcal{G}^\dagger\mathcal{G}^\dagger(-\frac{\pi}{4r})\hat{Q}\mathcal{G}(-\frac{\pi}{4r})\mathcal{G}\mid\psi\rangle)
$

với $\mathcal{G}(\mu+s)=e^{-i(\mu+s)G}=e^{-i\mu G}e^{-isG}=\mathcal{G}(\mu)\mathcal{G}(s)$:

$
\partial_{\mu}f=r(\langle\psi\mid\mathcal{G}^\dagger(\mu+\frac{\pi}{4r})\hat{Q}\mathcal{G}(\mu+\frac{\pi}{4r})\mid\psi\rangle+\langle\psi\mid(\mathcal{G}^\dagger(\mu-\frac{\pi}{4r})\hat{Q}\mathcal{G}(\mu-\frac{\pi}{4r})\mid\psi\rangle)
$

$
= r(f(\mu+\frac{\pi}{4r})-f(\mu-\frac{\pi}{4r}))\;(3.6)
$

Như bạn có thể thấy, phương trình (3.6) trông khá giống phương trình (1.4) nhưng với $\epsilon=\frac{\pi}{4r}$ và định nghĩa chính xác, không xấp xỉ.

#### **4. Bình luận**

Phương pháp **dời tham số** có thể áp dụng trong nhiều trường hợp.

Trường hợp 4.1: nếu $G$ thuộc $\frac{1}{2}\{\sigma_x,\sigma_y,\sigma_z\}$ thì $r=\frac{1}{2}$ và $s=\frac{\pi}{2}$

Trường hợp 2: nếu $G=r\overrightarrow{n}\sigma$ là tổ hợp tuyến tính của các toán tử Pauli $\sigma$ với $\overrightarrow{n}$ là vector 3 chiều bình thường.

Chứng minh: 

$$
G=r\begin{bmatrix}
n_X & n_Y & n_Z
\end{bmatrix}
\begin{bmatrix}
\sigma_X \\
\sigma_Y \\
\sigma_Z
\end{bmatrix}=r\begin{bmatrix}
n_Z & (n_X-in_Y) \\
(n_X+in_Y) & n_Z
\end{bmatrix}
$$

có hai trị riêng phân biệt:

$$
\lambda=\pm\sqrt{n_X^2+n_Y^2+n_Z^2}
$$

Trường hợp 3: một số cổng cơ bản của Xmon qubit trong Google Cirq như $ExpW(\mu,\delta)=e^{-i\mu(\sigma_X\cos{\delta}+\sigma_Y\sin{\delta})}$, $ExpZ(\mu)=e^{-i\mu\sigma_Z}$, $Exp11(\mu)=e^{-i\mu\mid\ 11 \rangle\langle 11 \mid}$, ...

Chứng minh với $ExpW(\mu,\delta)$:

$$
G(\delta)=\sigma_X\cos{\delta}+\sigma_Y\sin{\delta}=
\begin{bmatrix}
0 & (\cos{\delta}-i\sin{\delta}) \\
(\cos{\delta}+i\sin{\delta}) & 0
\end{bmatrix}=\begin{bmatrix}
0 & e^{-i\delta} \\
e^{i\delta} & 0
\end{bmatrix}
$$

Giải phương trình $det(G-\lambda\mathbb{I})=0$, suy ra $\lambda=\pm1$, tương tự với $ExpZ(\mu)$ và $Exp11(\mu)$.

Tuy nhiên, các cổng dựa trên toán tử Pauli có thể không thỏa mãn điều kiện trên. Ví dụ như cổng biến đổi điều khiển bằng vi sóng trên kiến trúc siêu dẫn

$
\mathcal{G}(\mu)=e^{\mu(\sigma_X\otimes\mathbb{I}-b(\sigma_Z\otimes\sigma_X)+c(\mathbb{I}\otimes\sigma_X))}
$

có 4 trị riêng là nghiệm của phương trình:

$
\lambda^4+2\lambda^2(1+b^2+c^2)+(2b^2-2c^2+(b^2-c^2)^2+1)=0.
$

*Kết thúc bài 1*


